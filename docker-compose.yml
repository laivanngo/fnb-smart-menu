# Tệp: projects/fnb-smart-menu/docker-compose.yml
# MỤC ĐÍCH: Dàn dựng cả 3 services (backend, frontend, admin) VÀ
#          cơ sở dữ liệu PostgreSQL production.

services:
  # --- Dịch vụ Backend (Đã CẬP NHẬT cho Postgres) ---
  backend:
    build:
      context: ./fnb-smart-menu-backend
      dockerfile: Dockerfile
    container_name: fnb_backend
    ports:
      - "8000:8000"
    volumes:
      # Mount thư mục uploads cho ảnh, thay vì thư mục database_data cũ
      - ./fnb-smart-menu-backend/uploads:/app/uploads
    environment:
      # === CUNG CẤP BIẾN MÔI TRƯỜNG CHO POSTGRES (mà models.py đang đọc) ===
      - SECRET_KEY=08dd74d3cb23bf8190d00fcac56c292a9a48c81bda6545c580b6391b942dbf0a
      - POSTGRES_USER=myadmin
      - POSTGRES_PASSWORD=mypassword123 # Bạn có thể đổi mật khẩu này
      - POSTGRES_DB=fnb_smart_menu_db
      - DB_HOST=db # Tên của service CSDL (xem bên dưới)
      - DB_PORT=5432
    restart: always
    depends_on:
      - db # Backend PHẢI khởi động sau CSDL

  # --- DỊCH VỤ DATABASE MỚI (PostgreSQL) ---
  db:
    image: postgres:14-alpine
    container_name: fnb_postgres_db
    environment:
      # Các biến này dùng để KHỞI TẠO CSDL lần đầu
      - POSTGRES_USER=myadmin
      - POSTGRES_PASSWORD=mypassword123 # Phải khớp với backend
      - POSTGRES_DB=fnb_smart_menu_db # Phải khớp với backend
    volumes:
      # Lưu trữ dữ liệu CSDL vĩnh viễn
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432" # Mở cổng để bạn có thể kết nối từ DBeaver/DataGrip
    restart: always

  # --- Dịch vụ Frontend Khách hàng (Giữ nguyên) ---
  frontend:
    build:
      context: ./fnb-smart-menu-frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://127.0.0.1:8000
    environment:
      API_URL: http://backend:8000
    container_name: fnb_frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend # Chờ backend sẵn sàng
    restart: always

  # --- Dịch vụ Frontend Admin (Giữ nguyên) ---
  admin:
    build:
      context: ./fnb-smart-menu-admin
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://127.0.0.1:8000
    container_name: fnb_admin
    ports:
      - "3001:3000"
    depends_on:
      - backend # Chờ backend sẵn sàng
    restart: always

# Định nghĩa volume để lưu trữ CSDL
volumes:
  postgres_data: