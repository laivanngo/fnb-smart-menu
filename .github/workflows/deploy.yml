# Tá»‡p: .github/workflows/deploy.yml
# "Báº£n hÆ°á»›ng dáº«n" cho Robot CI/CD

# 1. TÃŠN Cá»¦A ROBOT
name: Deploy to VPS (Triá»ƒn khai lÃªn VPS)

# 2. KHI NÃ€O ROBOT CHáº Y
on:
  push:
    branches:
      - main  # Chá»‰ cháº¡y khi cÃ³ code má»›i Ä‘Æ°á»£c Ä‘áº©y lÃªn nhÃ¡nh "main"

# 3. CÃ”NG VIá»†C ROBOT Cáº¦N LÃ€M
jobs:
  deploy:
    # Äáº·t tÃªn cho cÃ´ng viá»‡c
    name: Deploy
    # Robot sáº½ cháº¡y trÃªn má»™t mÃ¡y áº£o Ubuntu (do GitHub cung cáº¥p)
    runs-on: ubuntu-latest

    # CÃ¡c bÆ°á»›c robot sáº½ thá»±c hiá»‡n
    steps:
      # BÆ°á»›c 1: In ra mÃ n hÃ¬nh (Ä‘á»ƒ chÃºng ta biáº¿t nÃ³ Ä‘ang cháº¡y)
      - name: 1. Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh triá»ƒn khai
        run: echo "ğŸš€ Báº¯t Ä‘áº§u triá»ƒn khai code má»›i lÃªn VPS..."

      # BÆ°á»›c 2: CÃ i Ä‘áº·t "ChÃ¬a khÃ³a" (Private Key)
      # Robot sáº½ láº¥y "chÃ¬a khÃ³a" tá»« kÃ©t sáº¯t (GitHub Secrets) vÃ  cÃ i nÃ³ vÃ o mÃ¡y áº£o
      - name: 2. CÃ i Ä‘áº·t ChÃ¬a khÃ³a SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          # Láº¥y chÃ¬a khÃ³a tá»« Secret VPS_SSH_KEY
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # BÆ°á»›c 3: ÄÄƒng nháº­p vÃ o VPS vÃ  cháº¡y lá»‡nh
      # ÄÃ¢y lÃ  bÆ°á»›c robot dÃ¹ng chÃ¬a khÃ³a Ä‘á»ƒ SSH vÃ o VPS cá»§a báº¡n
      - name: 3. ÄÄƒng nháº­p VPS vÃ  cháº¡y lá»‡nh triá»ƒn khai
        uses: appleboy/ssh-action@v0.1.7
        with:
          # Láº¥y thÃ´ng tin Ä‘Äƒng nháº­p tá»« GitHub Secrets
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # === CÃC Lá»†NH ROBOT Sáº¼ CHáº Y TRÃŠN VPS ===
            
            # 1. Äi Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n
            echo "1/5 - Äi Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n..."
            cd ${{ secrets.PROJECT_PATH }}
            
            # 2. Láº¥y code má»›i nháº¥t tá»« GitHub
            echo "2/5 - KÃ©o code má»›i nháº¥t tá»« nhÃ¡nh 'main'..."
            git pull origin main
            
            # 3. Build vÃ  khá»Ÿi Ä‘á»™ng láº¡i cÃ¡c container
            echo "3/5 - Build láº¡i image vÃ  khá»Ÿi Ä‘á»™ng láº¡i dá»‹ch vá»¥..."
            docker compose --env-file .env.production -f docker-compose.production.yml up -d --build
            
            # 4. Dá»n dáº¹p cÃ¡c image cÅ© (khÃ´ng cÃ²n dÃ¹ng)
            echo "4/5 - Dá»n dáº¹p image cÅ©..."
            docker image prune -f
            
            # 5. HoÃ n táº¥t
            echo "5/5 - Triá»ƒn khai thÃ nh cÃ´ng! âœ…"